<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS 備忘錄 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F2F2F7;
            -webkit-font-smoothing: antialiased;
        }
        [contenteditable] { 
            outline: none; 
            caret-color: #FF9500;
        }
        [contenteditable]:empty:before {
            content: attr(placeholder);
            color: #d1d5db;
            cursor: text;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        ::selection { background-color: rgba(255, 149, 0, 0.2); }
        .sidebar-transition { transition: width 0.3s ease-in-out, opacity 0.3s; }
        img { max-width: 100%; border-radius: 8px; margin: 12px 0; display: block; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="overflow-hidden select-none">
    <div id="app" class="flex h-screen w-full text-black">
        <!-- 隱藏的檔案上傳 -->
        <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImageUpload(event)">

        <!-- 1. 左側邊欄：文件夾系統 -->
        <aside id="sidebar" class="sidebar-transition flex flex-col border-r border-gray-300 bg-[#E5E5EA]/70 glass z-20 w-72">
            <div class="p-6 mt-6 flex justify-between items-center min-w-[280px]">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar(false)" class="text-[#FF9500] p-1.5 hover:bg-gray-200 rounded-lg">
                        <i data-lucide="panel-left-close"></i>
                    </button>
                    <span class="text-2xl font-bold text-[#FF9500]">文件夾</span>
                </div>
                <button onclick="createNewNote()" class="text-[#FF9500] active:opacity-50">
                    <i data-lucide="square-pen"></i>
                </button>
            </div>
            
            <div class="flex-1 px-3 space-y-1 overflow-y-auto min-w-[280px] no-scrollbar">
                <div class="text-[11px] font-semibold text-gray-500 ml-2 mb-1 uppercase tracking-wider">iCloud</div>
                <div id="folder-list"></div>
                <div id="folder-add-container">
                    <button onclick="showAddFolderInput()" class="flex items-center gap-2 p-3 w-full text-[#FF9500] font-semibold hover:bg-gray-200 rounded-xl mt-2 transition-all">
                        <i data-lucide="plus"></i>
                        <span>新增文件夾</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- 2. 中間欄：備忘錄列表 -->
        <section id="list-column" class="sidebar-transition flex flex-col w-80 border-r border-gray-300 bg-white relative">
            <div class="p-4 pt-12 md:pt-6 min-w-[320px]">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <button id="sidebar-open-btn" onclick="toggleSidebar(true)" class="hidden text-[#FF9500] p-1.5 hover:bg-gray-100 rounded-lg">
                            <i data-lucide="panel-left"></i>
                        </button>
                        <h1 class="text-3xl font-bold tracking-tight">備忘錄</h1>
                    </div>
                </div>
                <div class="relative mb-4">
                    <i data-lucide="search" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                    <input type="text" id="search-input" placeholder="搜尋" oninput="handleSearch(this.value)"
                        class="w-full bg-[#E3E3E8]/70 rounded-xl py-2.5 pl-10 pr-4 outline-none focus:bg-[#E3E3E8]">
                </div>
            </div>

            <div id="notes-list" class="flex-1 overflow-y-auto px-4 pb-20 space-y-1 no-scrollbar min-w-[320px]"></div>
            <div id="notes-count" class="absolute bottom-0 w-full p-4 bg-white/80 glass border-t border-gray-100 text-center text-[12px] text-gray-500 min-w-[320px]"></div>
        </section>

        <!-- 3. 右側：編輯區域 -->
        <main id="editor-column" class="flex-1 flex flex-col bg-white relative hidden md:flex">
            <!-- 頂部導覽列 -->
            <nav class="flex items-center justify-between p-4 border-b border-gray-100 bg-white/90 glass z-10">
                <div class="flex items-center gap-2">
                    <!-- 切換左側側邊欄 -->
                    <button onclick="toggleSidebar()" class="hidden md:block text-[#FF9500] p-2 hover:bg-gray-100 rounded-lg transition-all" title="切換文件夾側邊欄">
                        <i data-lucide="panel-left"></i>
                    </button>
                    <!-- 新增：切換列表欄 -->
                    <button onclick="toggleListColumn()" class="hidden md:block text-[#FF9500] p-2 hover:bg-gray-100 rounded-lg transition-all" title="切換備忘錄列表">
                        <i data-lucide="layout-list"></i>
                    </button>
                    <button onclick="closeNoteMobile()" class="md:hidden text-[#FF9500] flex items-center gap-1">
                        <i data-lucide="chevron-left" class="w-7 h-7"></i>
                        <span class="font-semibold text-lg">備忘錄</span>
                    </button>
                </div>
                
                <div class="flex items-center gap-5">
                    <button onclick="toggleShareModal(true)" class="text-[#FF9500]"><i data-lucide="share"></i></button>
                    <button onclick="togglePin()" id="pin-btn" class="text-[#FF9500]"><i data-lucide="pin"></i></button>
                    <button onclick="deleteNote()" class="text-[#FF9500]"><i data-lucide="trash-2"></i></button>
                    <button onclick="createNewNote()" class="text-[#FF9500]"><i data-lucide="square-pen"></i></button>
                </div>
            </nav>

            <div id="editor-content" class="flex-1 flex flex-col bg-[#FCFCFD] relative overflow-hidden">
                <div id="editor-time" class="text-center py-4 text-[12px] font-semibold text-gray-400 uppercase tracking-widest"></div>
                
                <!-- AI Loading Indicator -->
                <div id="ai-loader" class="hidden absolute top-12 left-1/2 -translate-x-1/2 bg-[#FF9500] text-white px-5 py-2.5 rounded-full flex items-center gap-3 shadow-2xl z-50 animate-pulse">
                    <i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>
                    <span class="text-sm font-bold tracking-wide">✨ Gemini 正在分析...</span>
                </div>

                <!-- 編輯器 -->
                <div id="note-editor" 
                    contenteditable="true" 
                    placeholder="開始輸入..."
                    oninput="handleEditorInput()"
                    class="flex-1 w-full px-8 md:px-20 pb-40 overflow-y-auto text-xl leading-relaxed text-gray-800 no-scrollbar">
                </div>

                <!-- AI 選單 -->
                <div id="ai-menu" class="hidden absolute bottom-28 left-1/2 -translate-x-1/2 w-56 bg-white/95 glass rounded-3xl shadow-2xl border border-gray-100 overflow-hidden z-50">
                    <button onclick="handleAiAction('summary')" class="w-full px-5 py-4 text-left text-sm font-bold flex items-center gap-3 hover:bg-orange-50 text-gray-700 transition-colors border-b border-gray-50">
                        <span class="text-[#FF9500]"><i data-lucide="sparkles" class="w-4 h-4"></i></span> 智能摘要
                    </button>
                    <button onclick="handleAiAction('continue')" class="w-full px-5 py-4 text-left text-sm font-bold flex items-center gap-3 hover:bg-orange-50 text-gray-700 transition-colors border-b border-gray-50">
                        <span class="text-[#FF9500]"><i data-lucide="square-pen" class="w-4 h-4"></i></span> 繼續續寫
                    </button>
                    <button onclick="handleAiAction('optimize')" class="w-full px-5 py-4 text-left text-sm font-bold flex items-center gap-3 hover:bg-orange-50 text-gray-700 transition-colors border-b border-gray-50">
                        <span class="text-[#FF9500]"><i data-lucide="type" class="w-4 h-4"></i></span> 文字優化
                    </button>
                    <button onclick="handleAiAction('checklist')" class="w-full px-5 py-4 text-left text-sm font-bold flex items-center gap-3 hover:bg-orange-50 text-gray-700">
                        <span class="text-[#FF9500]"><i data-lucide="list-checks" class="w-4 h-4"></i></span> 提取待辦
                    </button>
                </div>

                <!-- 底部工具列 -->
                <div class="absolute bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-[500px] h-16 bg-white/90 glass rounded-3xl shadow-2xl border border-gray-200 flex items-center justify-around px-4">
                    <button onclick="toggleAiMenu()" class="p-3 text-[#FF9500] hover:bg-orange-50 rounded-2xl"><i data-lucide="sparkles"></i></button>
                    <div class="w-px h-8 bg-gray-200"></div>
                    <button onclick="insertHtmlAtCursor('<br>- [ ] &nbsp;')" class="p-3 text-[#FF9500] hover:bg-orange-50 rounded-2xl"><i data-lucide="check-circle-2"></i></button>
                    <button onclick="document.getElementById('image-input').click()" class="p-3 text-[#FF9500] hover:bg-orange-50 rounded-2xl"><i data-lucide="image"></i></button>
                    <button class="p-3 text-[#FF9500] hover:bg-orange-50 rounded-2xl"><i data-lucide="table"></i></button>
                    <div class="w-px h-8 bg-gray-200"></div>
                    <button onclick="closeNoteMobile()" class="text-[#FF9500] font-black text-lg px-2">完成</button>
                </div>
            </div>

            <!-- 空狀態 -->
            <div id="editor-placeholder" class="hidden flex-1 flex flex-col items-center justify-center text-gray-300 bg-[#FCFCFD]">
                <i data-lucide="square-pen" class="w-20 h-20 opacity-10 mb-4"></i>
                <p class="text-xl font-bold">選取備忘錄開始編輯</p>
            </div>
        </main>

        <!-- 分享面板 -->
        <div id="share-modal" class="hidden fixed inset-0 z-[100] flex items-end justify-center bg-black/30 glass transition-all" onclick="toggleShareModal(false)">
            <div class="w-full max-w-xl bg-[#F2F2F7] rounded-t-[40px] p-8 shadow-2xl" onclick="event.stopPropagation()">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-8"></div>
                <div class="flex items-center gap-5 mb-10 bg-white p-5 rounded-3xl shadow-sm">
                    <div class="w-16 h-16 bg-[#FF9500] rounded-2xl flex items-center justify-center text-white shadow-lg"><i data-lucide="square-pen" class="w-8 h-8"></i></div>
                    <div>
                        <div id="share-title" class="font-black text-xl">新備忘錄</div>
                        <div class="text-sm text-gray-400 font-bold">iCloud 備忘錄</div>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-6 mb-10 text-center">
                    <div class="flex flex-col items-center gap-3"><div class="bg-blue-500 w-16 h-16 rounded-[22px] flex items-center justify-center text-white"><i data-lucide="mail"></i></div><span class="text-xs font-bold text-gray-600">郵件</span></div>
                    <div onclick="copyContent()" class="flex flex-col items-center gap-3 cursor-pointer"><div class="bg-orange-500 w-16 h-16 rounded-[22px] flex items-center justify-center text-white"><i data-lucide="copy"></i></div><span class="text-xs font-bold text-gray-600">拷貝</span></div>
                    <div class="flex flex-col items-center gap-3"><div class="bg-purple-500 w-16 h-16 rounded-[22px] flex items-center justify-center text-white"><i data-lucide="link"></i></div><span class="text-xs font-bold text-gray-600">連結</span></div>
                    <div class="flex flex-col items-center gap-3"><div class="bg-gray-400 w-16 h-16 rounded-[22px] flex items-center justify-center text-white"><i data-lucide="more-horizontal"></i></div><span class="text-xs font-bold text-gray-600">更多</span></div>
                </div>
                <div class="bg-white rounded-[28px] overflow-hidden mb-10">
                    <div class="p-5 font-bold text-gray-800 border-b border-gray-50 hover:bg-gray-50 cursor-pointer">在備忘錄中尋找</div>
                    <div class="p-5 font-bold text-gray-800 border-b border-gray-50 hover:bg-gray-50 cursor-pointer">儲存到檔案</div>
                    <div class="p-5 font-bold text-gray-800 hover:bg-gray-50 cursor-pointer">列印</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 全域變數 ---
        let state = {
            notes: [],
            folders: ['所有 iCloud', '個人', '工作', '靈感'],
            activeFolder: '所有 iCloud',
            selectedNoteId: null,
            searchQuery: '',
            showSidebar: true,
            showList: true
        };

        const STORAGE_KEY = 'ios_notes_html_v3_flex';
        const apiKey = ""; 
        const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';

        // --- 初始化 ---
        function init() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
            } else {
                state.notes = [{
                    id: 'welcome-1',
                    title: '歡迎使用備忘錄 Pro',
                    content: '<div>歡迎使用備忘錄 Pro</div><div><br></div><div>現在您可以隱藏左側的任何欄位，享受最寬廣的寫作體驗！</div>',
                    updatedAt: new Date().toISOString(),
                    folder: '所有 iCloud',
                    pinned: true
                }];
            }
            render();
            lucide.createIcons();
        }

        function save() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        // --- UI 控制 ---
        function toggleSidebar(val) {
            state.showSidebar = val !== undefined ? val : !state.showSidebar;
            const aside = document.getElementById('sidebar');
            const openBtn = document.getElementById('sidebar-open-btn');
            
            if (state.showSidebar) {
                aside.classList.remove('w-0', 'opacity-0');
                aside.classList.add('w-72', 'opacity-100');
                openBtn.classList.add('hidden');
            } else {
                aside.classList.remove('w-72', 'opacity-100');
                aside.classList.add('w-0', 'opacity-0');
                openBtn.classList.remove('hidden');
            }
            save();
        }

        function toggleListColumn(val) {
            state.showList = val !== undefined ? val : !state.showList;
            const listCol = document.getElementById('list-column');
            
            if (state.showList) {
                listCol.classList.remove('w-0', 'opacity-0', 'pointer-events-none');
                listCol.classList.add('w-80', 'opacity-100');
            } else {
                listCol.classList.remove('w-80', 'opacity-100');
                listCol.classList.add('w-0', 'opacity-0', 'pointer-events-none');
            }
            save();
        }

        function createNewNote() {
            const newNote = {
                id: Date.now().toString(),
                title: '新備忘錄',
                content: '<div></div>',
                updatedAt: new Date().toISOString(),
                folder: state.activeFolder === '所有 iCloud' ? '個人' : state.activeFolder,
                pinned: false
            };
            state.notes.unshift(newNote);
            state.selectedNoteId = newNote.id;
            // 如果列表是隱藏的，自動打開它
            if (!state.showList) toggleListColumn(true);
            save();
            render();
            focusEditor();
        }

        function handleEditorInput() {
            const editor = document.getElementById('note-editor');
            const note = state.notes.find(n => n.id === state.selectedNoteId);
            if (note) {
                note.content = editor.innerHTML;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = note.content;
                const text = tempDiv.innerText || tempDiv.textContent;
                note.title = text.split('\n')[0].trim() || '無標題';
                note.updatedAt = new Date().toISOString();
                save();
                renderListOnly();
            }
        }

        function deleteNote() {
            state.notes = state.notes.filter(n => n.id !== state.selectedNoteId);
            state.selectedNoteId = null;
            save();
            render();
        }

        function togglePin() {
            const note = state.notes.find(n => n.id === state.selectedNoteId);
            if (note) {
                note.pinned = !note.pinned;
                save();
                render();
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgHtml = `<img src="${e.target.result}" alt="圖片">`;
                    insertHtmlAtCursor(imgHtml);
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }

        function insertHtmlAtCursor(html) {
            const editor = document.getElementById('note-editor');
            editor.focus();
            let sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                let range = sel.getRangeAt(0);
                range.deleteContents();
                const el = document.createElement("div");
                el.innerHTML = html;
                const frag = document.createDocumentFragment();
                let node, lastNode;
                while ((node = el.firstChild)) lastNode = frag.appendChild(node);
                range.insertNode(frag);
                if (lastNode) {
                    range = range.cloneRange();
                    range.setStartAfter(lastNode);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            } else {
                editor.innerHTML += html;
            }
            handleEditorInput();
        }

        function selectNote(id) {
            state.selectedNoteId = id;
            render();
        }

        function closeNoteMobile() {
            state.selectedNoteId = null;
            render();
        }

        function handleSearch(val) {
            state.searchQuery = val;
            renderListOnly();
        }

        function toggleShareModal(show) {
            const modal = document.getElementById('share-modal');
            const note = state.notes.find(n => n.id === state.selectedNoteId);
            if (note) document.getElementById('share-title').innerText = note.title;
            modal.classList.toggle('hidden', !show);
        }

        function toggleAiMenu() {
            const menu = document.getElementById('ai-menu');
            menu.classList.toggle('hidden');
        }

        function focusEditor() {
            const editor = document.getElementById('note-editor');
            if (editor) editor.focus();
        }

        async function handleAiAction(type) {
            const note = state.notes.find(n => n.id === state.selectedNoteId);
            if (!note || !note.content.trim()) return;
            toggleAiMenu();
            document.getElementById('ai-loader').classList.remove('hidden');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = note.content;
            const pureText = tempDiv.innerText;

            let systemPrompt = "";
            switch (type) {
                case 'summary': systemPrompt = "你是一個專業筆記秘書。請為備忘錄提供精簡繁體中文摘要，使用條列式。"; break;
                case 'continue': systemPrompt = "你是一個助手。請根據現有內容續寫約 150 字，直接輸出續寫部分。"; break;
                case 'optimize': systemPrompt = "你是一個文字編輯。請修正語法並優化語氣，直接輸出優化後的全文內容。"; break;
                case 'checklist': systemPrompt = "請將內容中的行動項目轉換為 '- [ ] 任務名稱' 的格式。僅輸出清單。"; break;
            }

            try {
                const result = await callGemini(pureText, systemPrompt);
                if (result) {
                    const formattedResult = result.replace(/\n/g, '<br>');
                    if (type === 'continue') insertHtmlAtCursor(`<br><br>${formattedResult}`);
                    else if (type === 'optimize') {
                        document.getElementById('note-editor').innerHTML = formattedResult;
                        handleEditorInput();
                    }
                    else insertHtmlAtCursor(`<br><br><b>--- ✨ AI ${type === 'summary' ? '摘要' : '清單'} ---</b><br>${formattedResult}`);
                }
            } catch (e) {
                console.error(e);
            } finally {
                document.getElementById('ai-loader').classList.add('hidden');
            }
        }

        async function callGemini(prompt, systemInstruction) {
            const execute = async () => {
                const res = await fetch(`${GEMINI_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            };
            for (let i = 0; i < 5; i++) {
                try { return await execute(); }
                catch (e) { await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000)); }
            }
        }

        function render() {
            renderFolders();
            renderListOnly();
            renderEditor();
            toggleSidebar(state.showSidebar);
            toggleListColumn(state.showList);
            lucide.createIcons();
        }

        function renderFolders() {
            const list = document.getElementById('folder-list');
            list.innerHTML = state.folders.map(f => `
                <div onclick="setActiveFolder('${f}')" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all ${state.activeFolder === f ? 'bg-[#FF9500] text-white shadow-sm' : 'text-gray-800 hover:bg-gray-200'}">
                    <i data-lucide="folder" class="${state.activeFolder === f ? 'text-white' : 'text-[#FF9500]'}"></i>
                    <span class="font-medium flex-1 truncate">${f}</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 opacity-40"></i>
                </div>
            `).join('');
        }

        function setActiveFolder(f) {
            state.activeFolder = f;
            render();
        }

        function renderListOnly() {
            const filtered = state.notes.filter(n => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = n.content;
                const pureText = tempDiv.innerText.toLowerCase();
                const matchesSearch = n.title.toLowerCase().includes(state.searchQuery.toLowerCase()) || pureText.includes(state.searchQuery.toLowerCase());
                const matchesFolder = state.activeFolder === '所有 iCloud' || n.folder === state.activeFolder;
                return matchesSearch && matchesFolder;
            }).sort((a, b) => {
                if (a.pinned !== b.pinned) return b.pinned ? -1 : 1;
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            });

            const list = document.getElementById('notes-list');
            list.innerHTML = filtered.map(n => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = n.content;
                const subText = tempDiv.innerText.split('\n')[1] || '尚未輸入內容';
                return `
                <div onclick="selectNote('${n.id}')" class="p-4 rounded-2xl cursor-pointer relative group ${state.selectedNoteId === n.id ? 'bg-[#FF9500] text-white shadow-lg' : 'hover:bg-gray-100 border-b border-gray-50'}">
                    <div class="font-bold truncate text-[16px] mb-0.5 pr-6">${n.title || '新備忘錄'}</div>
                    <div class="flex items-center gap-2">
                        <span class="text-[13px] font-medium shrink-0 ${state.selectedNoteId === n.id ? 'text-white/80' : 'text-gray-500'}">${formatDate(n.updatedAt)}</span>
                        <span class="text-[13px] truncate ${state.selectedNoteId === n.id ? 'text-white/60' : 'text-gray-400'}">${subText}</span>
                    </div>
                    ${n.pinned ? `<i data-lucide="pin" class="absolute top-4 right-3 w-3 h-3 ${state.selectedNoteId === n.id ? 'text-white' : 'text-[#FF9500]'}"></i>` : ''}
                </div>
            `}).join('');
            
            document.getElementById('notes-count').innerText = `${filtered.length} 個備忘錄`;
            lucide.createIcons();

            const listCol = document.getElementById('list-column');
            const editorCol = document.getElementById('editor-column');
            if (window.innerWidth < 768) {
                if (state.selectedNoteId) {
                    listCol.classList.add('hidden');
                    editorCol.classList.remove('hidden');
                } else {
                    listCol.classList.remove('hidden');
                    editorCol.classList.add('hidden');
                }
            }
        }

        function renderEditor() {
            const note = state.notes.find(n => n.id === state.selectedNoteId);
            const contentDiv = document.getElementById('editor-content');
            const placeholder = document.getElementById('editor-placeholder');
            const editor = document.getElementById('note-editor');
            const timeDiv = document.getElementById('editor-time');
            const pinBtn = document.getElementById('pin-btn');

            if (note) {
                contentDiv.classList.remove('hidden');
                placeholder.classList.add('hidden');
                if (editor.innerHTML !== note.content) editor.innerHTML = note.content;
                timeDiv.innerText = new Date(note.updatedAt).toLocaleString('zh-TW', { 
                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
                pinBtn.classList.toggle('fill-[#FF9500]', note.pinned);
            } else {
                contentDiv.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        function formatDate(d) {
            const date = new Date(d);
            const now = new Date();
            if (date.toDateString() === now.toDateString()) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return date.toLocaleDateString();
        }

        function copyContent() {
            const note = state.notes.find(n => n.id === state.selectedNoteId);
            if (note) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = note.content;
                const el = document.createElement('textarea');
                el.value = tempDiv.innerText;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                toggleShareModal(false);
            }
        }

        function showAddFolderInput() {
            const name = prompt("請輸入文件夾名稱：");
            if (name && !state.folders.includes(name)) {
                state.folders.push(name);
                save();
                render();
            }
        }

        window.onload = init;
        window.onresize = renderListOnly;
    </script>
</body>
</html>
